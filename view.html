<!DOCTYPE html>
<html>
    <head>
        <title>LS400 location</title>
        <meta name="viewport" content="initial-scale=1.0">
        <meta charset="utf-8">
        <style>
         html, body {
             height: 100%;
             margin: 0;
             padding: 0;
         }
         #map {
             height: 100%;
         }
        </style>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    </head>
    <body>
        <div id="map"></div>
        <script>
         var map;
         var API = 'https://qjafe0n2qc.execute-api.us-east-1.amazonaws.com/prod/tracker-g';
         var GOOGLE_API_KEY = 'AIzaSyCUhMSkMA41b5GUO-MKHlIc4mC1FYrPzXk';

         $.ajax(API, {
             method: 'GET',
             data: {},
             headers:{},
             success: drawPaths
         });

         function drawPaths(data, status, jqXHR) {
             var lat;
             var lng;
             var ts;

             var points = [];
             var accuracies = [];
             var timestamps = [];
             var statuses = [];

             data["Items"].forEach(function(item) {
                 if ("event" in item && (item["event"]["S"] == "g" || item["event"]["S"] == "cl")) {
                     var elems = item["data"]["S"].split(",");
                     if (elems.length >= 3) {
                         lat = parseFloat(elems[0]);
                         lng = parseFloat(elems[1]);
                         var acc = parseFloat(elems[2]);
                         accuracies.push(acc);
                         ts = new Date(item["published_at"]["S"]).toLocaleString();
                     } else {
                         return;
                     }
                 } else if ("event" in item && (item["event"]["S"] == "s")) {
                     statuses.push(item["data"]["S"]);
                     ts = new Date(item["published_at"]["S"]).toLocaleString();
                     timestamps.push(ts);
                     return;
                 } else {
                     return;
                 }

                 new google.maps.Marker({
                     position: {
                         lat: lat,
                         lng: lng
                     },
                     title: ts,
                     map: map,
                     icon: {
                         path: google.maps.SymbolPath.CIRCLE,
                         scale: 2,
                         strokeWeight: 1,
                         strokeColor: 'white',
                         strokeOpacity: 1.0,
                         fillColor: 'black',
                         fillOpacity: 1.0,
                         zIndex: -points.length
                     }
                 });
                 points.push({
                     lat: lat,
                     lng: lng
                 });
                 timestamps.push(ts);
             });

             // Draw lines
             new google.maps.Polyline({
                 path: points,
                 map: map
             })

             // Highlight last location. Points are stored in reverse order.
             if (points.length > 0) {
                 new google.maps.Marker({
                     position: points[0],
                     title: timestamps[0],
                     map: map,
                     icon: {
                         path: google.maps.SymbolPath.CIRCLE,
                         scale: 5,
                         strokeColor: 'red',
                         zIndex: 0
                     }
                 });
                 new google.maps.Circle({
                     center: points[0],
                     radius: accuracies[0],
                     map: map,
                     fillColor: 'cyan',
                     fillOpacity: 0.1,
                     strokeColor: 'cyan',
                     strokeOpacity: 0.4,
                     zIndex: 0
                 });
                 new google.maps.InfoWindow({
                     position: points[0],
                     content: timestamps[0] + "<br>" + statuses[0],
                     map: map,
                     zIndex: 0
                 });
                 map.setCenter(points[0]);
             }
         }

         function initMap() {
             map = new google.maps.Map(document.getElementById('map'),
                                       {center: {lat: 37.876683, lng: -122.256606}, zoom: 13});
         }
        </script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCUhMSkMA41b5GUO-MKHlIc4mC1FYrPzXk&callback=initMap"
                async defer></script>
    </body>
</html>
