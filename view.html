<!DOCTYPE html>
<html>
    <head>
        <title>LS400 location</title>
        <meta name="viewport" content="initial-scale=1.0">
        <meta charset="utf-8">
        <style>
         html, body {
             height: 100%;
             margin: 0;
             padding: 0;
         }
         #map {
             height: 100%;
         }
        </style>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    </head>
    <body>
        <div id="map"></div>
        <script>
         var map;
         var API = 'https://qjafe0n2qc.execute-api.us-east-1.amazonaws.com/prod/tracker-g';
         var GOOGLE_API_KEY = 'AIzaSyCUhMSkMA41b5GUO-MKHlIc4mC1FYrPzXk';

         $.ajax(API, {
             method: 'GET',
             data: {},
             headers:{},
             success: drawPaths
         });


         function drawPaths(data, status, jqXHR) {
             // timestamp -> {'point': {'lat': x, 'lng': y}, 'speed': v, 'accuracy': a, 'status': s}
             var items = {};

             function formatTimestamp(t) {
                 function pad(number) {
                     if (number < 10) {
                         return '0' + number;
                     }
                     return number;
                 }

                 var d = new Date(t);
                 return d.getFullYear() +
                        '-' + pad(d.getMonth() + 1) +
                        '-' + pad(d.getDate()) +
                        ' ' + pad(d.getHours()) +
                        ':' + pad(d.getMinutes()) +
                        ':' + pad(d.getSeconds());
             }

             data["Items"].forEach(function(item) {
                 if ("event" in item && (item["event"]["S"] == "g" || item["event"]["S"] == "cl")) {
                     var elems = item["data"]["S"].split(",");
                     if (elems.length >= 4) {
                         var time = formatTimestamp(item["published_at"]["S"]);
                         var lat = parseFloat(elems[0]);
                         var lng = parseFloat(elems[1]);
                         var acc = parseFloat(elems[2]);
                         var speed = parseFloat(elems[3]);
                         if (!(time in items)) {
                             items[time] = {};
                         }
                         $.extend(items[time], {'point': {'lat': lat, 'lng': lng}, 'speed': speed, 'accuracy': acc});
                     }
                 } else if ("event" in item && (item["event"]["S"] == "s")) {
                     var time = formatTimestamp(item["published_at"]["S"]);
                     var s = item["data"]["S"];
                     if (!(time in items)) {
                         items[time] = {};
                     }
                     $.extend(items[time], {'status': s});
                 }
             });

             var sortedKeys = Object.keys(items).sort().filter(function(t, i) {
                 return (new Date().getTime() - (24 * 60 * 60 * 1000)) < new Date(t).getTime();
             });

             function formatItem(t, isHTML) {
                 var nl = isHTML ? '<br>' : '\n';
                 var result = t;
                 if ('speed' in items[t]) {
                     result += nl + 'speed: ' + items[t]['speed'] + ' mph';
                 }
                 if ('status' in items[t]) {
                     result += nl + 'status: ' + items[t]['status'];
                 }
                 return result;
             }

             // Draw points
             sortedKeys.forEach(function(t, i) {
                 new google.maps.Marker({
                     position: items[t]['point'],
                     title: formatItem(t, false),
                     map: map,
                     icon: {
                         path: google.maps.SymbolPath.CIRCLE,
                         scale: 2,
                         strokeWeight: 1,
                         strokeColor: 'white',
                         strokeOpacity: 1.0,
                         fillColor: 'black',
                         fillOpacity: 1.0,
                     }
                 });

                 // Highlight points with status reports
                 if ('status' in items[t]) {
                     new google.maps.Marker({
                         position: items[t]['point'],
                         title: formatItem(t, false),
                         map: map,
                         icon: {
                             path: google.maps.SymbolPath.CIRCLE,
                             scale: 5,
                             strokeColor: 'green',
                         }
                     });
                     new google.maps.InfoWindow({
                         position: items[t]['point'],
                         content: formatItem(t, true),
                         map: map,
                     });
                 }
             });

             // Draw lines
             new google.maps.Polyline({
                 path: $.map(sortedKeys, function(t) {
                     return items[t]['point'];
                 }),
                 map: map
             })

             // Highlight last location
             if (sortedKeys.length > 0) {
                 var lastT = sortedKeys[sortedKeys.length - 1];
                 new google.maps.Marker({
                     position: items[lastT]['point'],
                     title: formatItem(lastT, false),
                     map: map,
                     icon: {
                         path: google.maps.SymbolPath.CIRCLE,
                         scale: 5,
                         strokeColor: 'red',
                     }
                 });
                 new google.maps.Circle({
                     center: items[lastT]['point'],
                     radius: items[lastT]['accuracy'],
                     map: map,
                     fillColor: 'cyan',
                     fillOpacity: 0.1,
                     strokeColor: 'cyan',
                     strokeOpacity: 0.4,
                 });
                 new google.maps.InfoWindow({
                     position: items[lastT]['point'],
                     content: formatItem(lastT, true),
                     map: map,
                 });
                 map.setCenter(items[lastT]['point']);
             }
         }

         function initMap() {
             map = new google.maps.Map(document.getElementById('map'),
                                       {center: {lat: 37.876683, lng: -122.256606}, zoom: 13});
         }
        </script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCUhMSkMA41b5GUO-MKHlIc4mC1FYrPzXk&callback=initMap"
                async defer></script>
    </body>
</html>
